<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Gallery</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <title>NestBook Home</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <meta name="description" content="">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="/user/home/css/vendor.css">
  <link rel="stylesheet" type="text/css" href="/user/home/style.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet">

  <style>
    .hide-nav-bar {
      display: none;
    }

    /* #category-icon{
      height: 64px;
      width: 64px;
    } */
    .sale-price {
      font-weight: bold;
    }

    .regular-price {
      color: rgb(118, 114, 106);
    }

    .offer-price {
      color: rgb(188, 147, 65);
    }

    .btn-wishlist.active svg {
      fill: red;
      stroke: red;
    }

    .add-to-cart-btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .add-to-cart-btn:hover {
      background-color: #0056b3;
    }

    .add-to-cart-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .btn-wishlist {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-wishlist:hover {
      background: white;
      transform: scale(1.1);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-wishlist svg {
      width: 20px;
      height: 20px;
      fill: #ccc;
      transition: fill 0.3s ease;
    }

    .btn-wishlist.active svg {
      fill: #e74c3c;
      /* Red color for active state */
    }

    .btn-wishlist:hover svg {
      fill: #e74c3c;
    }
  </style>


<body>
  <%- include('../partials/user/nav-bar')%>



    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <defs>
        <symbol xmlns="http://www.w3.org/2000/svg" id="link" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M12 19a1 1 0 1 0-1-1a1 1 0 0 0 1 1Zm5 0a1 1 0 1 0-1-1a1 1 0 0 0 1 1Zm0-4a1 1 0 1 0-1-1a1 1 0 0 0 1 1Zm-5 0a1 1 0 1 0-1-1a1 1 0 0 0 1 1Zm7-12h-1V2a1 1 0 0 0-2 0v1H8V2a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3Zm1 17a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-9h16Zm0-11H4V6a1 1 0 0 1 1-1h1v1a1 1 0 0 0 2 0V5h8v1a1 1 0 0 0 2 0V5h1a1 1 0 0 1 1 1ZM7 15a1 1 0 1 0-1-1a1 1 0 0 0 1 1Zm0 4a1 1 0 1 0-1-1a1 1 0 0 0 1 1Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="arrow-right" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M17.92 11.62a1 1 0 0 0-.21-.33l-5-5a1 1 0 0 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1 1 0 0 0 0 1.42a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 .21-.33a1 1 0 0 0 0-.76Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="category" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 5.5h-6.28l-.32-1a3 3 0 0 0-2.84-2H5a3 3 0 0 0-3 3v13a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-10a3 3 0 0 0-3-3Zm1 13a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-13a1 1 0 0 1 1-1h4.56a1 1 0 0 1 .95.68l.54 1.64a1 1 0 0 0 .95.68h7a1 1 0 0 1 1 1Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="calendar" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 4h-2V3a1 1 0 0 0-2 0v1H9V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-7h16Zm0-9H4V7a1 1 0 0 1 1-1h2v1a1 1 0 0 0 2 0V6h6v1a1 1 0 0 0 2 0V6h2a1 1 0 0 1 1 1Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="heart" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M20.16 4.61A6.27 6.27 0 0 0 12 4a6.27 6.27 0 0 0-8.16 9.48l7.45 7.45a1 1 0 0 0 1.42 0l7.45-7.45a6.27 6.27 0 0 0 0-8.87Zm-1.41 7.46L12 18.81l-6.75-6.74a4.28 4.28 0 0 1 3-7.3a4.25 4.25 0 0 1 3 1.25a1 1 0 0 0 1.42 0a4.27 4.27 0 0 1 6 6.05Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="plus" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 11h-6V5a1 1 0 0 0-2 0v6H5a1 1 0 0 0 0 2h6v6a1 1 0 0 0 2 0v-6h6a1 1 0 0 0 0-2Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="minus" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 11H5a1 1 0 0 0 0 2h14a1 1 0 0 0 0-2Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="cart" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M8.5 19a1.5 1.5 0 1 0 1.5 1.5A1.5 1.5 0 0 0 8.5 19ZM19 16H7a1 1 0 0 1 0-2h8.491a3.013 3.013 0 0 0 2.885-2.176l1.585-5.55A1 1 0 0 0 19 5H6.74a3.007 3.007 0 0 0-2.82-2H3a1 1 0 0 0 0 2h.921a1.005 1.005 0 0 1 .962.725l.155.545v.005l1.641 5.742A3 3 0 0 0 7 18h12a1 1 0 0 0 0-2Zm-1.326-9l-1.22 4.274a1.005 1.005 0 0 1-.963.726H8.754l-.255-.892L7.326 7ZM16.5 19a1.5 1.5 0 1 0 1.5 1.5a1.5 1.5 0 0 0-1.5-1.5Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="check" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M18.71 7.21a1 1 0 0 0-1.42 0l-7.45 7.46l-3.13-3.14A1 1 0 1 0 5.29 13l3.84 3.84a1 1 0 0 0 1.42 0l8.16-8.16a1 1 0 0 0 0-1.47Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="trash" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M10 18a1 1 0 0 0 1-1v-6a1 1 0 0 0-2 0v6a1 1 0 0 0 1 1ZM20 6h-4V5a3 3 0 0 0-3-3h-2a3 3 0 0 0-3 3v1H4a1 1 0 0 0 0 2h1v11a3 3 0 0 0 3 3h8a3 3 0 0 0 3-3V8h1a1 1 0 0 0 0-2ZM10 5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1h-4Zm7 14a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8h10Zm-3-1a1 1 0 0 0 1-1v-6a1 1 0 0 0-2 0v6a1 1 0 0 0 1 1Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="star-outline" viewBox="0 0 15 15">
          <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
            d="M7.5 9.804L5.337 11l.413-2.533L4 6.674l2.418-.37L7.5 4l1.082 2.304l2.418.37l-1.75 1.793L9.663 11L7.5 9.804Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="star-solid" viewBox="0 0 15 15">
          <path fill="currentColor"
            d="M7.953 3.788a.5.5 0 0 0-.906 0L6.08 5.85l-2.154.33a.5.5 0 0 0-.283.843l1.574 1.613l-.373 2.284a.5.5 0 0 0 .736.518l1.92-1.063l1.921 1.063a.5.5 0 0 0 .736-.519l-.373-2.283l1.574-1.613a.5.5 0 0 0-.283-.844L8.921 5.85l-.968-2.062Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="search" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7a7 7 0 0 1-7 7Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="user" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M15.71 12.71a6 6 0 1 0-7.42 0a10 10 0 0 0-6.22 8.18a1 1 0 0 0 2 .22a8 8 0 0 1 15.9 0a1 1 0 0 0 1 .89h.11a1 1 0 0 0 .88-1.1a10 10 0 0 0-6.25-8.19ZM12 12a4 4 0 1 1 4-4a4 4 0 0 1-4 4Z" />
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="close" viewBox="0 0 15 15">
          <path fill="currentColor"
            d="M7.953 3.788a.5.5 0 0 0-.906 0L6.08 5.85l-2.154.33a.5.5 0 0 0-.283.843l1.574 1.613l-.373 2.284a.5.5 0 0 0 .736.518l1.92-1.063l1.921 1.063a.5.5 0 0 0 .736-.519l-.373-2.283l1.574-1.613a.5.5 0 0 0-.283-.844L8.921 5.85l-.968-2.062Z" />
        </symbol>
      </defs>
    </svg>





    <div class="hide-nav-bar">
      <%- include('../partials/user/nav-bar') %>
    </div>

    <section class="py-3"
      style="background-image: url('images/background-pattern.jpg');background-repeat: no-repeat;background-size: cover;">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">

            <div class="banner-blocks">

              <div class="banner-ad large block-1 bg-info " id="background1">

                <div class="swiper main-swiper">
                  <div class="swiper-wrapper">

                    <div class="swiper-slide">
                      <div class="row banner-content p-5">
                        <div class="content-wrapper col-md-7">
                          <div class="categories my-3">100% natural</div>
                          <h3 class="display-4">Fresh Smoothie & Summer Juice</h3>
                          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Dignissim massa diam elementum.
                          </p>
                          <a href="#"
                            class="btn btn-outline-dark btn-lg text-uppercase fs-6 rounded-1 px-4 py-3 mt-3">Shop
                            Now</a>
                        </div>
                        <div class="img-wrapper col-md-5">
                          <img src="images/product-thumb-1.png" class="img-fluid">
                        </div>
                      </div>
                    </div>

                    <div class="swiper-slide">
                      <div class="row banner-content p-5">
                        <div class="content-wrapper col-md-7">
                          <div class="categories mb-3 pb-3">100% natural</div>
                          <h3 class="banner-title">Fresh Smoothie & Summer Juice</h3>
                          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Dignissim massa diam elementum.
                          </p>
                          <a href="#" class="btn btn-outline-dark btn-lg text-uppercase fs-6 rounded-1">Shop
                            Collection</a>
                        </div>
                        <div class="img-wrapper col-md-5">
                          <img src="images/product-thumb-1.png" class="img-fluid">
                        </div>
                      </div>
                    </div>

                    <div class="swiper-slide">
                      <div class="row banner-content p-5">
                        <div class="content-wrapper col-md-7">
                          <div class="categories mb-3 pb-3">100% natural</div>
                          <h3 class="banner-title">Heinz Tomato Ketchup</h3>
                          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Dignissim massa diam elementum.
                          </p>
                          <a href="#" class="btn btn-outline-dark btn-lg text-uppercase fs-6 rounded-1">Shop
                            Collection</a>
                        </div>
                        <div class="img-wrapper col-md-5">
                          <img src="images/product-thumb-2.png" class="img-fluid">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="swiper-pagination"></div>

                </div>
              </div>

              <div class="banner-ad bg-success-subtle block-2"
                style="background:url('images/ad-image-1.png') no-repeat;background-position: right bottom">
                <div class="row banner-content p-5">

                  <div class="content-wrapper col-md-7">
                    <div class="categories sale mb-3 pb-3">20% off</div>
                    <h3 class="banner-title">Fruits & Vegetables</h3>
                    <a href="#" class="d-flex align-items-center nav-link">Shop Collection <svg width="24" height="24">
                        <use xlink:href="#arrow-right"></use>
                      </svg></a>
                  </div>

                </div>
              </div>

              <div id="background3" class="banner-ad bg-danger block-3"
                style="background:url('images/ad-image-2.png') no-repeat;background-position: right bottom">
                <div class="row banner-content p-5">

                  <div class="content-wrapper col-md-7">
                    <div class="categories sale mb-3 pb-3">15% off</div>
                    <h3 class="item-title">Baked Products</h3>
                    <a href="#" class="d-flex align-items-center nav-link">Shop Collection <svg width="24" height="24">
                        <use xlink:href="#arrow-right"></use>
                      </svg></a>
                  </div>

                </div>
              </div>

            </div>
            <!-- / Banner Blocks -->

          </div>
        </div>
      </div>
    </section>

    <%if(categories.length>0){%>
      <section class="py-5 overflow-hidden">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">

              <div class="section-header d-flex flex-wrap justify-content-between mb-5">
                <h2 class="section-title">Category</h2>

                <div class="d-flex align-items-center">
                  <!-- <a href="#" class="btn-link text-decoration-none">View All Categories →</a> -->
                  <div class="swiper-buttons">
                    <button class="swiper-prev category-carousel-prev btn btn-yellow">❮</button>
                    <button class="swiper-next category-carousel-next btn btn-yellow">❯</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
          <div class="row">
            <div class="col-md-12">

              <div class="category-carousel swiper">
                <div class="swiper-wrapper">
                  <%categories.forEach((category)=>{%>
                    <a href="/user/products?category=<%=category._id%>" class="nav-link category-item swiper-slide">
                      <img src="/assets/category-icon-3.png" alt="Category Thumbnail" id="category-icon">
                      <h3 class="category-title">
                        <%=category.name%>
                      </h3>
                    </a>
                    <%})%>



                </div>
              </div>

            </div>
          </div>
        </div>
      </section>
      <%}%>




        <section class="py-5">
          <div class="container-fluid">

            <div class="row">
              <div class="col-md-12">






                <%if(newArrivals.length>0){%>
                  <section class="py-5 overflow-hidden">
                    <div class="container-fluid">
                      <div class="row">
                        <div class="col-md-12">
                          <div class="section-header d-flex justify-content-between">
                            <h2 class="section-title">Just arrived</h2>
                            <div class="d-flex align-items-center">
                              <a href="/user/products" class="btn-link text-decoration-none">View All Books →</a>
                              <div class="swiper-buttons">
                                <button class="swiper-prev products-carousel-prev btn btn-primary">❮</button>
                                <button class="swiper-next products-carousel-next btn btn-primary">❯</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <div class="products-carousel swiper">
                            <div class="swiper-wrapper">
                              <% for(let i=0; i < newArrivals.length; ++i) { %>
                                <div class="product-item swiper-slide">
                                  <!-- <button class="btn-wishlist add-to-wishlist" data-product-id="<%= newArrivals[i]._id %>">
                                    <svg width="24" height="24">
                                      <use xlink:href="#heart"></use>
                                    </svg>
                                  </button> -->
                                  <button
                                    class="btn-wishlist add-to-wishlist <%= wishlistProductIds.includes(newArrivals[i]._id) ? 'active' : '' %>"
                                    data-product-id="<%= newArrivals[i]._id %>">
                                    <svg width="24" height="24">
                                      <use xlink:href="#heart"></use>
                                    </svg>
                                  </button>
                                  <figure>
                                    <a href="/user/productDetail?id=<%= newArrivals[i]._id %>" title="Product Title">
                                      <img src="/<%=newArrivals[i].image[0]%>" alt="<%=newArrivals[i].productName%>"
                                        class="tab-image">
                                    </a>
                                  </figure>
                                  <h3>
                                    <%=newArrivals[i].productName%>
                                  </h3>
                                  <span class="rating">
                                    <svg width="24" height="24" class="text-primary">
                                      <use xlink:href="#star-solid"></use>
                                    </svg>
                                    <%= newArrivals[i].avgRating.toFixed(1) %>
                                  </span>
                                  <div>
                                    <span class="sale-price">₹<%=newArrivals[i].salePrice%></span>&nbsp;
                                    <span class="regular-price"><del>₹<%=newArrivals[i].regularPrice%>
                                      </del></span>&nbsp;
                                    <span class="offer-price">(<%=newArrivals[i].productOffer%>% Off)</span>
                                  </div>
                                  <div class="d-flex align-items-center justify-content-between">
                                    <div class="input-group product-qty">
                                      <span class="input-group-btn">
                                        <button type="button" class="quantity-left-minus btn btn-danger btn-number"
                                          data-type="minus" data-product-id="<%= newArrivals[i]._id %>">
                                          <svg width="16" height="16">
                                            <use xlink:href="#minus"></use>
                                          </svg>
                                        </button>
                                      </span>
                                      <input type="text" name="quantity"
                                        class="form-control input-number quantity-input"
                                        data-product-id="<%= newArrivals[i]._id %>"
                                        data-max-quantity="<%= newArrivals[i].quantity %>" value="1">
                                      <span class="input-group-btn">
                                        <button type="button" class="quantity-right-plus btn btn-success btn-number"
                                          data-type="plus" data-product-id="<%= newArrivals[i]._id %>">
                                          <svg width="16" height="16">
                                            <use xlink:href="#plus"></use>
                                          </svg>
                                        </button>
                                      </span>
                                    </div>
                                    <!-- CHANGED: Add to Cart button with proper attributes -->
                                    <button class="btn btn-primary add-to-cart-btn"
                                      data-product-id="<%= newArrivals[i]._id %>">
                                      Add to Cart <iconify-icon icon="uil:shopping-cart"></iconify-icon>
                                    </button>
                                  </div>
                                </div>
                                <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>

                  <!-- <script>
                    document.addEventListener('DOMContentLoaded',function(){
                      const addToWishlistButton=document.querySelectorAll('add-to-wishlist')
                      addToWishlistButton.forEach(button=>{
                        button.addEventListener('click',async function(e){
                          e.preventDefault()

                           const productId = this.getAttribute('data-product-id');
                          const productItem = this.closest('.product-item');

                          if (!productId) {
                            alert('Product ID not found');
                            return;
                          }

                          try {
                             const response = await fetch('/user/add-to-wishlist', {
                              method: 'POST',
                              headers: {
                                'Content-Type': 'application/json',
                              },
                              credentials: 'include',
                              body: JSON.stringify({
                                productId: productId,
                                
                              })
                            });


                            const data = await response.json();

                            if (data.success) {
                              alert('Product added to wishlist successfully!');
                             
                            } else {
                              if (data.redirect) {
                                window.location.href = data.redirect;
                              } else {
                                alert('Error: ' + data.message);
                              }
                            }
                          } catch (error) {
                             console.error('Error:', error);
                            alert('Error adding product to cart');
                          }
                        })
                      })
                    })
                  </script> -->
                  <script>
                    document.addEventListener('DOMContentLoaded', function () {
                      // Initialize wishlist buttons with correct state
                      initializeWishlistButtons();

                      // Setup wishlist click handlers
                      setupWishlistFunctionality();
                    });

                    async function initializeWishlistButtons() {
                      // Check wishlist status for each product
                      const wishlistButtons = document.querySelectorAll('.add-to-wishlist');

                      for (const button of wishlistButtons) {
                        const productId = button.getAttribute('data-product-id');

                        try {
                          const response = await fetch(`/user/check-wishlist/${productId}`, {
                            credentials: 'include'
                          });
                          const data = await response.json();

                          if (data.inWishlist) {
                            button.classList.add('active');
                          } else {
                            button.classList.remove('active');
                          }
                        } catch (error) {
                          console.error('Error checking wishlist status:', error);
                        }
                      }
                    }

                    function setupWishlistFunctionality() {
                      const wishlistButtons = document.querySelectorAll('.add-to-wishlist');

                      wishlistButtons.forEach(button => {
                        button.addEventListener('click', async function (e) {
                          e.preventDefault();

                          const productId = this.getAttribute('data-product-id');

                          if (!productId) {
                            alert('Product ID not found');
                            return;
                          }

                          try {
                            // Toggle active class immediately for better UX
                            const isActive = this.classList.contains('active');

                            if (isActive) {
                              // Remove from wishlist
                              this.classList.remove('active');
                              const response = await fetch('/user/remove-from-wishlist', {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                  productId: productId  // Note: Using productId instead of itemId
                                })
                              });

                              const data = await response.json();

                              if (data.success) {
                                // Button already updated
                              } else {
                                this.classList.add('active'); // Revert if failed
                                alert('Error: ' + data.message);
                              }
                            } else {
                              // Add to wishlist
                              this.classList.add('active');
                              const response = await fetch('/user/add-to-wishlist', {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                  productId: productId
                                })
                              });

                              const data = await response.json();

                              if (data.success) {
                                // Button already updated
                              } else {
                                this.classList.remove('active'); // Revert if failed
                                alert('Error: ' + data.message);
                              }
                            }
                          } catch (error) {
                            console.error('Error:', error);
                            alert('Error updating wishlist');
                          }
                        });
                      });
                    }
                  </script>


                  <script>
                    // Add to Cart functionality
                    document.addEventListener('DOMContentLoaded', function () {
                      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');

                      addToCartButtons.forEach(button => {
                        button.addEventListener('click', async function (e) {
                          e.preventDefault();

                          const productId = this.getAttribute('data-product-id');
                          const productItem = this.closest('.product-item');
                          const quantityInput = productItem.querySelector('.quantity-input');
                          const quantity = quantityInput ? parseInt(quantityInput.value) : 1;

                          if (!productId) {
                            alert('Product ID not found');
                            return;
                          }

                          try {
                            // Show loading state
                            const originalHTML = this.innerHTML;
                            this.innerHTML = 'Adding...';
                            this.disabled = true;

                            const response = await fetch('/user/add-to-cart', {
                              method: 'POST',
                              headers: {
                                'Content-Type': 'application/json',
                              },
                              credentials: 'include',
                              body: JSON.stringify({
                                productId: productId,
                                quantity: quantity
                              })
                            });

                            const data = await response.json();

                            if (data.success) {
                              alert('Product added to cart successfully!');
                              updateCartCount();
                            } else {
                              if (data.redirect) {
                                window.location.href = data.redirect;
                              } else {
                                alert('Error: ' + data.message);
                              }
                            }

                          } catch (error) {
                            console.error('Error:', error);
                            alert('Error adding product to cart');
                          } finally {
                            // Reset button state
                            this.innerHTML = 'Add to Cart <iconify-icon icon="uil:shopping-cart"></iconify-icon>';
                            this.disabled = false;
                          }
                        });
                      });

                      // Update cart count in navbar
                      function updateCartCount() {
                        const cartCountElement = document.getElementById('cart-count');
                        if (cartCountElement) {
                          const currentCount = parseInt(cartCountElement.textContent) || 0;
                          cartCountElement.textContent = currentCount + 1;
                        }
                      }

                      // Your existing quantity control functionality
                      setupCarouselQuantityControls();
                    });

                    // Your existing quantity control functions (keep them as they are)
                    function setupCarouselQuantityControls() {
                      // Increase button event listeners
                      document.querySelectorAll('.quantity-right-plus').forEach(button => {
                        button.addEventListener('click', function () {
                          const productId = this.getAttribute('data-product-id');
                          const input = this.closest('.product-qty').querySelector('.quantity-input');
                          const maxQuantity = parseInt(input.getAttribute('data-max-quantity'));

                          let currentValue = parseInt(input.value) || 0;

                          if (currentValue < maxQuantity) {
                            input.value = currentValue + 1;
                          } else {
                            console.log("Maximum quantity reached");
                          }

                          updateCarouselQuantityButtons(productId);
                        });
                      });

                      // Decrease button event listeners
                      document.querySelectorAll('.quantity-left-minus').forEach(button => {
                        button.addEventListener('click', function () {
                          const productId = this.getAttribute('data-product-id');
                          const input = this.closest('.product-qty').querySelector('.quantity-input');

                          let currentValue = parseInt(input.value) || 0;

                          if (currentValue > 1) {
                            input.value = currentValue - 1;
                          }

                          updateCarouselQuantityButtons(productId);
                        });
                      });

                      // Manual input validation
                      document.querySelectorAll('.quantity-input').forEach(input => {
                        input.addEventListener('change', function () {
                          const productId = this.getAttribute('data-product-id');
                          const maxQuantity = parseInt(this.getAttribute('data-max-quantity'));

                          let value = parseInt(this.value) || 0;

                          if (value < 1) {
                            this.value = 1;
                          } else if (value > maxQuantity) {
                            this.value = maxQuantity;
                          }

                          updateCarouselQuantityButtons(productId);
                        });
                      });
                    }

                    function updateCarouselQuantityButtons(productId) {
                      const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                      if (!input) return;

                      const maxQuantity = parseInt(input.getAttribute('data-max-quantity'));
                      const currentValue = parseInt(input.value) || 0;
                      const increaseBtn = document.querySelector(`.quantity-right-plus[data-product-id="${productId}"]`);
                      const decreaseBtn = document.querySelector(`.quantity-left-minus[data-product-id="${productId}"]`);

                      if (increaseBtn) {
                        if (currentValue >= maxQuantity) {
                          increaseBtn.style.opacity = "0.5";
                          increaseBtn.style.cursor = "not-allowed";
                        } else {
                          increaseBtn.style.opacity = "1";
                          increaseBtn.style.cursor = "pointer";
                        }
                      }

                      if (decreaseBtn) {
                        if (currentValue <= 1) {
                          decreaseBtn.style.opacity = "0.5";
                          decreaseBtn.style.cursor = "not-allowed";
                        } else {
                          decreaseBtn.style.opacity = "1";
                          decreaseBtn.style.cursor = "pointer";
                        }
                      }
                    }


                    // Initialize button states on page load
                    document.addEventListener('DOMContentLoaded', function () {
                      document.querySelectorAll('.quantity-input').forEach(input => {
                        const productId = input.getAttribute('data-product-id');
                        updateCarouselQuantityButtons(productId);
                      });
                    });
                  </script>
                  <%}%>
                    <%- include('../partials/user/footer')%>



                      <%if(message){%>
                        <script>
                          alert('<%=message%>')
                        </script>
                        <%}%>


                          <script>
                            const urlparams = new URLSearchParams(window.location.search)
                            const message = urlparams.get('message')
                            if (message) {
                              alert(message)
                            }
                          </script>

                          <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
                          <script
                            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
                          <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
                          <script src="js/jquery-1.11.0.min.js"></script>
                          <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
                          <script
                            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
                          <script src="js/plugins.js"></script>
                          <script src="js/script.js"></script>
</body>

</html>